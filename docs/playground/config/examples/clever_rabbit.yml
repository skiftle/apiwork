title: Nested Saves
description: Create, update, and delete nested records in a single request
order: 3

sections:
  - title: API Definition
    files:
      - config/apis/clever_rabbit.rb
  - title: Models
    files:
      - app/models/clever_rabbit/order.rb
      - app/models/clever_rabbit/line_item.rb
      - app/models/clever_rabbit/shipping_address.rb
  - title: Schemas
    files:
      - app/schemas/clever_rabbit/order_schema.rb
      - app/schemas/clever_rabbit/line_item_schema.rb
      - app/schemas/clever_rabbit/shipping_address_schema.rb
  - title: Contracts
    files:
      - app/contracts/clever_rabbit/order_contract.rb
      - app/contracts/clever_rabbit/line_item_contract.rb
      - app/contracts/clever_rabbit/shipping_address_contract.rb
  - title: Controllers
    files:
      - app/controllers/clever_rabbit/orders_controller.rb

scenarios:
  - title: List all orders
    description: Returns orders with nested data
    order: 1
    method: GET
    path: /clever_rabbit/orders
    setup:
      - create: order
        fields:
          order_number: ORD-001
      - create: order
        fields:
          order_number: ORD-002

  - title: Get order details
    description: Fetch order with line items
    order: 2
    method: GET
    path: /clever_rabbit/orders/:id
    setup:
      - create: order
        fields:
          order_number: ORD-001

  - title: Create order with nested records
    description: Create order with line items and address
    order: 3
    method: POST
    path: /clever_rabbit/orders
    body:
      order:
        order_number: ORD-001
        line_items:
          - product_name: Widget
            quantity: 2
            unit_price: 29.99
          - product_name: Gadget
            quantity: 1
            unit_price: 49.99
        shipping_address:
          street: 123 Main St
          city: Springfield
          postal_code: "12345"
          country: USA

  - title: Update order with new items
    description: Replace order line items
    order: 4
    method: PATCH
    path: /clever_rabbit/orders/:id
    setup:
      - create: order
        fields:
          order_number: ORD-001
    body:
      order:
        order_number: ORD-001
        line_items:
          - product_name: New Item
            quantity: 3
            unit_price: 19.99

  - title: Delete an order
    description: Remove order and nested records
    order: 5
    method: DELETE
    path: /clever_rabbit/orders/:id
    setup:
      - create: order
        fields:
          order_number: ORD-001

  - title: Remove nested record
    description: Delete line item using _op
    order: 6
    method: PATCH
    path: /clever_rabbit/orders/:order_id
    setup:
      - create: order
        fields:
          order_number: ORD-001
      - create: line_item
        fields:
          order_id: :order_id
          product_name: Widget to Remove
          quantity: 1
          unit_price: 29.99
      - create: line_item
        fields:
          order_id: :order_id
          product_name: Widget to Keep
          quantity: 2
          unit_price: 19.99
    body:
      order:
        line_items:
          - id: :line_item_id
            _op: 'delete'
